<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Matrix Solutions Network — Digital ID</title>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- CSV -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Turf -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <style>
    :root{
      --bg:#07100b; --text:#ffffff;
      --orange:#ff9900; --red:#ff3333; --mint:#7be2b1; --matrix:#21ff9d;
      --countryText:#dfffe9;
      --barPadY:16px; --barPadX:16px;
      --dynBarH: 92px;
    }
    html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 30% 10%, #0b2217 0%, #081911 35%, #06140f 70%, #05100c 100%);color:var(--text);font-family:"Share Tech Mono",ui-monospace,monospace;}

    /* ===== TOP BAR ===== */
    #topbar{
      position:fixed; z-index:1100; left:0; right:0; top:0;
      padding:var(--barPadY) var(--barPadX);
      background:linear-gradient(180deg,rgba(10,30,20,.70),rgba(8,22,16,.86));
      border-bottom:1px solid rgba(11,42,28,.6);
      box-shadow:0 10px 28px rgba(0,0,0,.45);
      backdrop-filter: blur(3px);
      display:flex; flex-direction:column; align-items:center; gap:8px;
    }
    #brandRow{display:flex; align-items:center; gap:10px; white-space:nowrap;}
    #brandText{display:flex; flex-direction:column; align-items:center; gap:6px; text-align:center;}
    #brandText .msn{ color:var(--matrix); }
    #statusRow{ display:flex; align-items:center; gap:8px; }
    #pageTitle{ color:#ffffff }
    .live{ font-size:11px; color:#ffffff; background:var(--red); padding:3px 8px; border-radius:999px; border:1px solid #ff6b6b; }
    #metaCol{ display:flex; flex-direction:column; align-items:center; gap:4px; font-size:12px; }
    .updated{ color:#ffffff; opacity:.9 } .inline-hint{ opacity:.85 }

    #burgerMenu{ width:40px; height:40px; border-radius:10px; margin-left:10px; background:#062015; border:1px solid #1b5a3e; color:#fff; font-size:18px; font-weight:800; cursor:pointer; }
    @media (max-width: 720px){
      #burgerMenu{ position:fixed; right:12px; bottom:12px; z-index:1150; width:48px; height:48px; border-radius:12px; margin-left:0; }
    }

    #mobileMenu{
      position:fixed; left:8px; right:8px; top:calc(var(--dynBarH) + 8px);
      background:rgba(11,30,22,.92); border:1px solid #144832; border-radius:12px;
      padding:10px; z-index:1101; display:none; box-shadow:0 12px 28px rgba(0,0,0,.55); backdrop-filter: blur(2px);
    }
    #mobileMenu a{ display:block; margin:6px 0; text-decoration:none; }
    .btn{ background:#062015; border:1px solid #1b5a3e; color:#ffffff; padding:8px 10px; border-radius:10px; text-decoration:none; white-space:nowrap; font-weight:700; letter-spacing:.3px; font-size:13px; display:inline-block; }
    .btn:hover{ box-shadow:0 0 18px rgba(33,255,157,.20) }

    /* ===== MAP ===== */
    #map{ position:absolute; left:0; right:0; top:var(--dynBarH); bottom:0; }
    .leaflet-tile { filter: brightness(1.08) contrast(1.08) saturate(0.95); }
    .leaflet-top{ top:12px; }

    /* Popup & tooltip text */
    .leaflet-popup-content-wrapper{background:#0a1c14;color:#ffffff;border:1px solid #174d35;}
    .leaflet-popup-tip{background:#0a1c14;border:1px solid #174d35;}
    .leaflet-tooltip{background:#0a1c14;border:1px solid #174d35;color:var(--countryText) !important;}
    .leaflet-popup-content h3{ color:var(--countryText) !important; }

    /* Ensure SVG paths accept taps/clicks reliably */
    .country-hit{ cursor:pointer; pointer-events:auto; }
  </style>
</head>
<body>
  <!-- ===== TOP BAR ===== -->
  <div id="topbar" role="navigation" aria-label="Map header">
    <div id="brandRow">
      <div id="brandText">
        <span class="msn">Matrix Solutions Network</span>
        <div id="statusRow">
          <span id="pageTitle">Digital ID Status</span>
          <span class="live" id="livePill">LIVE</span>
        </div>
        <div id="metaCol">
          <div class="updated" id="updatedTop">Updated: …</div>
          <div class="inline-hint">• Click any dot or country for details</div>
        </div>
      </div>
      <button id="burgerMenu" aria-label="Open menu">≡</button>
    </div>
  </div>

  <!-- BURGER DROPDOWN -->
  <div id="mobileMenu" role="menu" aria-label="Navigation">
    <a class="btn" href="../" title="Back to Agenda Tracker">← Back to Agenda Tracker</a>
    <a class="btn" href="https://www.notion.so/Matrix-Solutions-Network-Dashboard-264f848a73ef8089a7edf4149ea664a5?source=copy_link" target="_blank" rel="noopener">MSN Dashboard ↗</a>
    <a class="btn" href="../cbdc/">Open CBDC Map</a>
    <a class="btn" href="../social-credit-system/">Open Social Credit Map</a>
  </div>

  <!-- MAP -->
  <div id="map" aria-label="Digital ID world map"></div>

  <script>
    /* ========= CONFIG ========= */
    const SHEET_PUBLISHED_LINK =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsoZwmLz701G4Q5zFjGsL_RO8yjfxe4jY0woh-YL_-ATX6Mc4Rzxf3cSP7LzLN9OCt5Is_s1FHHAWs/pub?gid=0&single=true&output=csv";
    function toCsvUrl(u){
      if (!u) return u;
      if (/output=csv/i.test(u)) return u;
      if (/\/pubhtml/i.test(u)){ const url = new URL(u); url.pathname = url.pathname.replace(/\/pubhtml/i,"/pub"); url.searchParams.set("output","csv"); if(!url.searchParams.has("single")) url.searchParams.set("single","true"); return url.toString(); }
      if (/\/spreadsheets\/d\//i.test(u)){ const m = u.match(/\/spreadsheets\/d\/([^/]+)/i); if(m){ const id=m[1]; const url=new URL(`https://docs.google.com/spreadsheets/d/${id}/export`); url.searchParams.set("format","csv"); return url.toString(); } }
      return u;
    }
    const CSV_URL = toCsvUrl(SHEET_PUBLISHED_LINK);

    /* ========= NORMALIZATION ========= */
    const COUNTRY_ALIASES = new Map([
      ["usa","united states"], ["u.s.a.","united states"], ["u.s.","united states"], ["us","united states"], ["united states of america","united states"],
      ["uk","united kingdom"], ["england","united kingdom"], ["scotland","united kingdom"], ["wales","united kingdom"], ["northern ireland","united kingdom"],
      ["uae","united arab emirates"], ["u.a.e.","united arab emirates"],
      ["türkiye","turkey"], ["turkiye","turkey"],
      ["republic of korea","south korea"], ["korea (republic of)","south korea"],
      ["ivory coast","cote d ivoire"], ["côte d’ivoire","cote d ivoire"], ["cote d'ivoire","cote d ivoire"],
      ["czech republic","czechia"], ["swaziland","eswatini"], ["burma","myanmar"],
      ["macedonia","north macedonia"], ["lao pdr","laos"],
      ["democratic republic of congo","democratic republic of the congo"], ["drc","democratic republic of the congo"],
      ["russian federation","russia"], ["viet nam","vietnam"], ["iran (islamic republic of)","iran"],
      ["bolivia (plurinational state of)","bolivia"], ["brunei darussalam","brunei"],
      ["republic of serbia","serbia"], ["canada (ca)","canada"], ["united states (us)","united states"]
    ]);
    const CENTROID_OVERRIDES = new Map([
      ["norway",[60.4720, 8.4689]], ["russia",[61.5240, 105.3188]], ["new zealand",[-41.0, 172.0]],
      ["chile",[-35.6751, -71.5430]], ["mauritius",[-20.2000, 57.5000]],
      ["spain",[40.4168, -3.7038]], ["italy",[42.5, 12.5]], ["denmark",[56.2639, 9.5019]],
      ["united kingdom",[52.3555,-1.1743]], ["serbia",[44.0165, 21.0059]],
      ["united states",[39.8283,-98.5795]], ["canada",[56.1304,-106.3468]],
      ["costa rica",[9.7489, -83.7534]], ["japan",[36.2048, 138.2529]]
    ]);
    function normalizeCountry(s){
      const k = String(s||"")
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/[^a-z0-9 ]+/gi,' ')
        .replace(/\s+/g,' ')
        .toLowerCase().trim();
      return COUNTRY_ALIASES.get(k) || k;
    }
    function splitCountries(cell){
      return String(cell).replace(/・/g, ',')
        .split(/\s*(?:,|;|\/|&|\band\b)\s*/i)
        .map(s=>s.trim()).filter(Boolean);
    }
    function titleCase(s){ return String(s).split(' ').map(w=>w? w[0].toUpperCase()+w.slice(1):'').join(' '); }
    function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'}[s])); }

    /* ========= MAP ========= */
    const map = L.map('map', { zoomControl:true, preferCanvas:true }).setView([20,0], 2);

    // Explicit panes to stabilize z-order
    map.createPane('hitPane');  map.getPane('hitPane').style.zIndex = 590;   // below markers
    map.createPane('dotsPane'); map.getPane('dotsPane').style.zIndex = 610;  // above polygons
    map.getPane('hitPane').style.pointerEvents = 'auto'; // ★ allow clicks on the pane

    const tiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png', {
      attribution:'&copy; OpenStreetMap &copy; CARTO', subdomains:'abcd', maxZoom:8
    }).addTo(map);

    const dotsRenderer = L.canvas({ pane: 'dotsPane', padding: 0.3 });
    const hitRenderer  = L.svg({ pane: 'hitPane' }); // ★ SVG so pointer events work perfectly

    const dotsLayer = L.layerGroup().addTo(map);
    let outlineLayer = null;
    let hitLayer = null;

    let worldGeo = null;
    let centroidByKey = {};
    let entries = [];

    /* ===== Burger ===== */
    const burger = document.getElementById('burgerMenu');
    const mobileMenu = document.getElementById('mobileMenu');
    burger.addEventListener('click', (e)=>{ e.stopPropagation(); mobileMenu.style.display = (mobileMenu.style.display === 'block') ? 'none' : 'block'; });
    document.addEventListener('click', (e)=>{ if (!mobileMenu.contains(e.target) && e.target !== burger) mobileMenu.style.display = 'none'; });

    /* ===== Layout ===== */
    const topbar = document.getElementById('topbar');
    function placeMap(){ const h = topbar.offsetHeight; document.documentElement.style.setProperty('--dynBarH', h+'px'); setTimeout(()=> map.invalidateSize(), 0); }
    window.addEventListener('load', placeMap);
    window.addEventListener('resize', placeMap);
    if (document.fonts) { document.fonts.ready.then(placeMap); }
    new ResizeObserver(placeMap).observe(topbar);

    /* ===== Helpers ===== */
    function centroidInside(feature){
      try { const c=turf.centerOfMass(feature).geometry.coordinates; return L.latLng(c[1], c[0]); }
      catch(e){ return L.geoJSON(feature).getBounds().getCenter(); }
    }
    function popupHTML(country, rows){
      const list = rows.map(r=>{
        const bits=[];
        if (r.title)  bits.push(`<strong>Program:</strong> ${escapeHtml(r.title)}`);
        if (r.status) bits.push(`<strong>Status:</strong> ${escapeHtml(r.status)}`);
        if (Number.isInteger(r.year)) bits.push(`<strong>Year:</strong> ${r.year}`);
        if (r.notes)  bits.push(`<span style="opacity:.8">${escapeHtml(r.notes)}</span>`);
        return `<div style="margin-bottom:8px">${bits.join('<br>')}</div>`;
      }).join('');
      return `<div style="min-width:240px"><h3 style="margin:0 0 6px 0; font-size:16px;">${escapeHtml(country)}</h3>${list}</div>`;
    }
    function getCSS(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
    function darken(hex, amt){ const n=parseInt(hex.replace('#',''),16); let r=(n>>16)-amt,g=((n>>8)&255)-amt,b=(n&255)-amt; r=Math.max(0,Math.min(255,r)); g=Math.max(0,Math.min(255,g)); b=Math.max(0,Math.min(255,b)); return '#'+(b|(g<<8)|(r<<16)).toString(16).padStart(6,'0'); }
    function* groupByCountry(arr){ const m=new Map(); for(const e of arr){ if(!m.has(e.key)) m.set(e.key,[]); m.get(e.key).push(e);} for(const kv of m) yield kv; }
    function forceDotsRedraw(){ map.invalidateSize(); requestAnimationFrame(()=>{ map.fire('zoomend'); map.fire('moveend'); }); }

    function openCountryPopup(countryKey){
      if (!countryKey) return;
      const rows = entries.filter(e=>e.key===countryKey);
      const pt = centroidByKey[countryKey];
      if (!pt) return;
      const html = rows.length ? popupHTML(rows[0].country, rows) : `<div style="min-width:240px;">No record in dataset.</div>`;
      L.popup({autoClose:true, closeOnClick:true}).setLatLng(pt).setContent(html).openOn(map);
    }

    /* ===== Data loaders ===== */
    async function loadWorld(){
      const SOURCES=[
        'https://cdn.jsdelivr.net/npm/world-countries@4/countries.geo.json',
        'https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson',
        'https://unpkg.com/@geo-maps/countries-land-1m@1.0.2/countries-land-1m.geo.json'
      ];
      let geo=null;
      for (const src of SOURCES){
        try{
          const r=await fetch(src,{cache:'default',mode:'cors'}); if(!r.ok) throw new Error(`HTTP ${r.status}`);
          const j=await r.json(); if(!j || !j.features || j.features.length<100) throw new Error('Bad geojson');
          geo=j; break;
        }catch(e){}
      }
      if(!geo) throw new Error('World polygons failed to load');

      centroidByKey = {};
      L.geoJSON(geo).eachLayer(l=>{
        const p=l.feature&&l.feature.properties||{};
        const nmRaw=p.name||p.NAME||p.NAME_EN||p.ADMIN||p.SOVEREIGNT;
        if(!nmRaw) return;
        const nm = normalizeCountry(nmRaw);
        if (CENTROID_OVERRIDES.has(nm)){ const [lat,lng]=CENTROID_OVERRIDES.get(nm); centroidByKey[nm]=L.latLng(lat,lng); }
        else { centroidByKey[nm]=centroidInside(l.feature); }
        if (l.feature && l.feature.properties) l.feature.properties._key = nm;
      });
      return geo;
    }

    async function loadSheet(){
      const res = await fetch(`${CSV_URL}${CSV_URL.includes('?') ? '&' : '?'}cb=${Date.now()}`, { cache:'no-store' });
      if (!res.ok) throw new Error(`CSV fetch failed: ${res.status}`);
      const dateHdr = res.headers.get('Date') || '';
      document.getElementById('updatedTop').textContent = 'Updated: ' + (dateHdr || new Date().toUTCString());

      const text = await res.text();
      const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });
      const rawRows = parsed.data;

      const out=[]; const unmatched=new Set();
      function pickYear(row){
        const keys=["Year","Start year","Start Year","Go live year","Go-live year","Go Live Year"];
        for(const k of keys){ if(row[k] && /^\d{4}$/.test(String(row[k]).trim())) return parseInt(row[k]); }
        return null;
      }

      for (const row of rawRows){
        const title = String(row["Title"]||"").trim();
        const status = String(row["Status"]||"").trim();
        const notes  = String(row["Description"]||"").trim();
        const yr     = pickYear(row);
        const countriesCell = String(row["Countries"]||"").trim();
        if (!countriesCell) continue;

        for (const raw of splitCountries(countriesCell)){
          const key = normalizeCountry(raw);
          const alt = key.replace(/^(republic|kingdom)\sof\s/,'').trim();
          const pt = centroidByKey[key] || centroidByKey[alt];
          if (!pt){ unmatched.add(raw); continue; }
          const isImplemented = /implement/i.test(status);
          const isDev = /develop|discussion|pilot|trial|poc|concept/i.test(status);
          out.push({ key, country:titleCase(key), lat:pt.lat, lng:pt.lng, status, isImplemented, isDev, title, notes, year:yr });
        }
      }
      if (unmatched.size) console.warn("Unmatched country tokens:", [...unmatched].sort());
      return out;
    }

    /* ===== Init sequence ===== */
    (async function init(){
      try{
        const geo = await loadWorld();
        const rows = await loadSheet();
        worldGeo = geo;
        entries = rows;
        drawAll();
      }catch(e){ console.error(e); }
    })();

    function drawAll(){
      // Outline
      if (outlineLayer) outlineLayer.remove();
      outlineLayer = L.geoJSON(worldGeo, { style: { color:getCSS('--mint'), weight:0.6, opacity:0.35, fill:false } }).addTo(map);

      // Dots
      dotsLayer.clearLayers();
      for (const [countryKey, rows] of groupByCountry(entries)){
        const pt = centroidByKey[countryKey]; if (!pt) continue;
        const isImplemented = rows.some(r=>r.isImplemented);
        const color = isImplemented ? getCSS('--red') : getCSS('--orange');
        const m = L.circleMarker([pt.lat, pt.lng], {
          renderer: dotsRenderer,
          radius: 6.5,
          color: darken(color,30),
          weight: 1.2,
          fillColor: color,
          fillOpacity: 0.95
        })
        .bindTooltip(`${rows[0].country}`, {direction:'top', offset:[0,-6]})
        .on('click', ()=> openCountryPopup(countryKey))
        .addTo(dotsLayer);
        if (m.bringToFront) m.bringToFront();
      }

      // Country hit layer — SVG below markers, with reliable hit area
      if (hitLayer) hitLayer.remove();
      hitLayer = L.geoJSON(worldGeo, {
        renderer: hitRenderer,
        pane: 'hitPane',
        style: () => ({
          className: 'country-hit',      // ★ ensure cursor + events
          color:'#0000',
          weight:0,
          fill:true,
          fillColor:'#000',
          fillOpacity:0.08               // ★ slightly higher for touch hit-testing (still invisible)
        }),
        interactive: true,
        onEachFeature: (f, layer) => {
          const key = (f.properties && f.properties._key) || '';
          layer.on('click', () => openCountryPopup(key));
          // Optional hover outline on desktop
          layer.on('mouseover', () => layer.setStyle({weight:1, color:getCSS('--mint'), opacity:.6}));
          layer.on('mouseout',  () => layer.setStyle({weight:0, color:'#0000'}));
        }
      }).addTo(map);

      // Nudge first paint
      map.once('idle', forceDotsRedraw);
      requestAnimationFrame(forceDotsRedraw);
      setTimeout(forceDotsRedraw, 0);
    }
  </script>
</body>
</html>
