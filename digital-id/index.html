<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Matrix Solutions Network — Digital ID</title>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- CSV -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Turf (centroid fallback) -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <style>
    :root{
      --bg:#07100b; --text:#ffffff;
      --orange:#ff9900; --red:#ff3333; --mint:#7be2b1; --matrix:#21ff9d;
      --barPadY:16px; --barPadX:16px; --dynBarH: 92px;
      --countryText:#dfffe9;
    }

    html,body{
      height:100%;margin:0;
      background:radial-gradient(1200px 800px at 30% 10%, #0b2217 0%, #081911 35%, #06140f 70%, #05100c 100%);
      color:var(--text);
      font-family:"Share Tech Mono",ui-monospace,monospace;
    }

    /* ===== Top bar ===== */
    #topbar{
      position:fixed; z-index:1100; left:0; right:0; top:0;
      padding:var(--barPadY) var(--barPadX);
      background:linear-gradient(180deg,rgba(10,30,20,.70),rgba(8,22,16,.86));
      border-bottom:1px solid rgba(11,42,28,.6);
      box-shadow:0 10px 28px rgba(0,0,0,.45);
      backdrop-filter: blur(3px);
      display:flex; flex-direction:column; align-items:center; gap:8px;
    }
    #brandWrap{display:flex; flex-direction:column; align-items:center; gap:6px; text-align:center;}
    .msn{color:var(--matrix)}
    #rowStatus{display:flex; align-items:center; gap:8px}
    #pageTitle{color:#fff}
    .live{font-size:11px;color:#ffffff;background:var(--red);padding:3px 8px;border-radius:999px;border:1px solid #ff6b6b}
    .updated{opacity:.9;font-size:12px}
    .inline-hint{opacity:.85;font-size:12px}

    /* === Right-side quick links (replaces burger) === */
    #toplinks{
      position:absolute; right:var(--barPadX); top:50%;
      transform:translateY(-50%);
      display:flex; gap:8px;
    }
    .toplink{
      background:#062015; border:1px solid #1b5a3e; color:#ffffff;
      padding:8px 10px; border-radius:10px; text-decoration:none;
      white-space:nowrap; font-weight:700; letter-spacing:.3px; font-size:13px;
    }
    .toplink:hover{ box-shadow:0 0 18px rgba(33,255,157,.20) }

    @media (max-width:720px){
      #toplinks{ position:static; transform:none; margin-top:6px; flex-wrap:wrap; justify-content:center; }
      .toplink{ padding:7px 9px; font-size:12px }
    }

    /* ===== Map ===== */
    #map{ position:absolute; left:0; right:0; top:var(--dynBarH); bottom:0; }
    .leaflet-container{ background:#081911; }
    .leaflet-tile{ background:#081911; transform:translateZ(0); }
    .leaflet-tile { filter: brightness(1.08) contrast(1.08) saturate(0.95); }
    .leaflet-top{ top:12px; }

    /* Brighten labels-only tiles (country names) */
    .leaflet-labelsPane-pane img { filter: brightness(1.6) contrast(1.25); }

    /* Popup / tooltip */
    .leaflet-popup-content-wrapper{background:#0a1c14;color:#ffffff;border:1px solid #174d35;}
    .leaflet-popup-tip{background:#0a1c14;border:1px solid #174d35;}
    .leaflet-tooltip{background:#0a1c14;border:1px solid #174d35;color:var(--countryText) !important;}

    /* Hit polygons must accept events */
    .country-hit.leaflet-interactive{ pointer-events:auto !important; cursor:pointer; }
  </style>
</head>
<body>
  <div id="topbar">
    <div id="brandWrap">
      <div class="msn">Matrix Solutions Network</div>
      <div id="rowStatus">
        <span id="pageTitle">Digital ID Status</span>
        <span class="live">LIVE</span>
      </div>
      <div class="updated" id="updatedTop">Updated: …</div>
      <div class="inline-hint">• Click any dot or country for details</div>
    </div>

    <!-- Right-side quick links -->
    <div id="toplinks" aria-label="Quick links">
      <a class="toplink" href="../cbdc/" title="Open the CBDC tracker">CBDC Tracker</a>
      <a class="toplink" href="../social-credit-system/" title="Open the Social Credit System tracker">Social Credit Tracker</a>
    </div>
  </div>

  <div id="map" aria-label="Digital ID world map"></div>

  <script>
    /* ===== CONFIG ===== */
    const SHEET_PUBLISHED_LINK =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsoZwmLz701G4Q5zFjGsL_RO8yjfxe4jY0woh-YL_-ATX6Mc4Rzxf3cSP7LzLN9OCt5Is_s1FHHAWs/pub?gid=0&single=true&output=csv";

    // --- New: small local CSV fallback so the app still runs if fetch is blocked ---
    const FALLBACK_CSV = `Title,Status,Description,Year,Countries\n`+
      `National eID,Implemented,Live national digital identity,2023,United Kingdom\n`+
      `Digital ID Pilot,In development,Phase 2 pilot,2025,United States\n`+
      `MyKad,Implemented,Malaysia ID,2012,Malaysia\n`+
      `DNIe,Implemented,Spain smart ID,2016,Spain`;

    function toCsvUrl(u){
      if (!u) return u;
      if (/output=csv/i.test(u)) return u;
      if (/\/pubhtml/i.test(u)){ const url=new URL(u); url.pathname=url.pathname.replace(/\/pubhtml/i,"/pub"); url.searchParams.set("output","csv"); if(!url.searchParams.has("single")) url.searchParams.set("single","true"); return url.toString(); }
      if (/\/spreadsheets\/d\//i.test(u)){ const m=u.match(/\/spreadsheets\/d\/([^/]+)/i); if(m){ const id=m[1]; const url=new URL(`https://docs.google.com/spreadsheets/d/${id}/export`); url.searchParams.set("format","csv"); return url.toString(); } }
      return u;
    }
    const CSV_URL = toCsvUrl(SHEET_PUBLISHED_LINK);

    const COUNTRY_ALIASES = new Map([
      ["usa","united states"],["u.s.a.","united states"],["u.s.","united states"],["us","united states"],["united states of america","united states"],
      ["uk","united kingdom"],["england","united kingdom"],["scotland","united kingdom"],["wales","united kingdom"],["northern ireland","united kingdom"],
      ["uae","united arab emirates"],["u.a.e.","united arab emirates"],
      ["türkiye","turkey"],["turkiye","turkey"],
      ["republic of korea","south korea"],["korea (republic of)","south korea"],
      ["ivory coast","cote d ivoire"],["côte d’ivoire","cote d ivoire"],["cote d'ivoire","cote d ivoire"],
      ["czech republic","czechia"],["swaziland","eswatini"],["burma","myanmar"],
      ["macedonia","north macedonia"],["lao pdr","laos"],
      ["democratic republic of congo","democratic republic of the congo"],["drc","democratic republic of the congo"],
      ["russian federation","russia"],["viet nam","vietnam"],["iran (islamic republic of)","iran"],
      ["bolivia (plurinational state of)","bolivia"],["brunei darussalam","brunei"],
      ["republic of serbia","serbia"],["canada (ca)","canada"],["united states (us)","united states"]
    ]);
    const CENTROID_OVERRIDES = new Map([
      ["norway",[60.4720,8.4689]],["russia",[61.5240,105.3188]],["new zealand",[-41,172]],
      ["chile",[-35.6751,-71.5430]],["mauritius",[-20.2,57.5]],["spain",[40.4168,-3.7038]],
      ["italy",[42.5,12.5]],["denmark",[56.2639,9.5019]],["united kingdom",[52.3555,-1.1743]],
      ["serbia",[44.0165,21.0059]],["united states",[39.8283,-98.5795]],["canada",[56.1304,-106.3468]],
      ["costa rica",[9.7489,-83.7534]],["japan",[36.2048,138.2529]],
      ["malaysia",[4.2105,101.9758]]
    ]);

    function normalizeCountry(s){
      const k=String(s||"").normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9 ]+/gi,' ').replace(/\s+/g,' ').toLowerCase().trim();
      return COUNTRY_ALIASES.get(k)||k;
    }
    function splitCountries(cell){
      return String(cell).replace(/・/g,',').split(/\s*(?:,|;|\/|&|\band\b)\s*/i).map(s=>s.trim()).filter(Boolean);
    }
    function titleCase(s){return String(s).split(' ').map(w=>w? w[0].toUpperCase()+w.slice(1):'').join(' ');}
    function escapeHtml(str){return String(str).replace(/[&<>"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s]));}
    function getCSS(name){return getComputedStyle(document.documentElement).getPropertyValue(name).trim();}
    function darken(hex,amt){const n=parseInt(hex.replace('#',''),16);let r=(n>>16)-amt,g=((n>>8)&255)-amt,b=(n&255)-amt;r=Math.max(0,Math.min(255,r));g=Math.max(0,Math.min(255,g));b=Math.max(0,Math.min(255,b));return '#'+(b|(g<<8)|(r<<16)).toString(16).padStart(6,'0');}
    function haversine(a,b){const toRad=d=>d*Math.PI/180,R=6371;const dLat=toRad(b[0]-a[0]),dLng=toRad(b[1]-a[1]);const s1=Math.sin(dLat/2)**2+Math.cos(toRad(a[0]))*Math.cos(toRad(b[0]))*Math.sin(dLng/2)**2;return 2*R*Math.asin(Math.sqrt(s1));}

    /* ===== Map & panes ===== */
    const map = L.map('map',{zoomControl:true,preferCanvas:true}).setView([20,0],2);

    // custom panes
    map.createPane('dotsPane');   map.getPane('dotsPane').style.zIndex = 650;
    map.createPane('labelsPane'); map.getPane('labelsPane').style.zIndex = 450;
    map.getPane('labelsPane').style.pointerEvents = 'none';

    // base tiles (no labels)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/dark_nolabels/{z}/{x}/{y}{r}.png',{
      attribution:'&copy; OpenStreetMap &copy; CARTO', subdomains:'abcd', maxZoom:8
    }).addTo(map);

    // labels-only overlay
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/dark_only_labels/{z}/{x}/{y}{r}.png',{
      subdomains:'abcd', maxZoom:8, pane:'labelsPane'
    }).addTo(map);

    const dotsRenderer = L.canvas({ pane:'dotsPane', padding:0.3 });

    // Layers
    const linesImpLayer = L.layerGroup().addTo(map);
    const linesDevLayer = L.layerGroup().addTo(map);
    const dotsLayer     = L.layerGroup().addTo(map);
    let outlineLayer=null, shadeLayer=null, hitLayer=null;

    /* ===== Layout (bar height -> map top) ===== */
    const topbar=document.getElementById('topbar');
    function placeMap(){ const h=topbar.offsetHeight; document.documentElement.style.setProperty('--dynBarH', h+'px'); setTimeout(()=>map.invalidateSize(),0); }
    window.addEventListener('load',placeMap); window.addEventListener('resize',placeMap); if(document.fonts){document.fonts.ready.then(placeMap);} new ResizeObserver(placeMap).observe(topbar);

    /* ===== Data + interactions ===== */
    let worldGeo=null, centroidByKey={}, entries=[];

    function centroidInside(feature){
      try{ const c=turf.centerOfMass(feature).geometry.coordinates; return L.latLng(c[1],c[0]); }
      catch(e){ return L.geoJSON(feature).getBounds().getCenter(); }
    }
    function popupHTML(country, rows){
      const list = rows.map(r=>{
        const b=[]; if(r.title)b.push(`<strong>Program:</strong> ${escapeHtml(r.title)}`);
        if(r.status)b.push(`<strong>Status:</strong> ${escapeHtml(r.status)}`);
        if(Number.isInteger(r.year))b.push(`<strong>Year:</strong> ${r.year}`);
        if(r.notes)b.push(`<span style="opacity:.8">${escapeHtml(r.notes)}</span>`);
        return `<div style="margin-bottom:8px">${b.join('<br>')}</div>`;
      }).join('');
      return `<div style="min-width:240px"><h3 style="margin:0 0 6px 0; font-size:16px;color:${getCSS('--countryText')}">${escapeHtml(country)}</h3>${list}</div>`;
    }
    function openCountryPopup(countryKey){
      if(!countryKey) return;
      const rows=entries.filter(e=>e.key===countryKey);
      const pt=centroidByKey[countryKey];
      if(!pt) return;
      const html=rows.length?popupHTML(rows[0].country,rows):`<div style="min-width:240px;">No record in dataset.</div>`;
      L.popup({autoClose:true, closeOnClick:true}).setLatLng(pt).setContent(html).openOn(map);
    }

    // --- New: fetch helper with timeout + local fallback ---
    async function fetchCsvOrFallback(url, timeoutMs=7000){
      try{
        const ctrl = new AbortController();
        const t = setTimeout(()=>ctrl.abort(), timeoutMs);
        const res = await fetch(url, { cache:'no-store', mode:'cors', signal: ctrl.signal });
        clearTimeout(t);
        if(!res.ok) throw new Error('Bad status '+res.status);
        const dateHdr = res.headers.get('Date') || new Date().toUTCString();
        document.getElementById('updatedTop').textContent = 'Updated: ' + dateHdr;
        return await res.text();
      }catch(err){
        console.warn('[CSV] Falling back to embedded sample data because fetch failed:', err);
        document.getElementById('updatedTop').textContent = 'Updated: Local sample data';
        return FALLBACK_CSV;
      }
    }

    (async function init(){
      // 1) world polygons
      const sources=[
        'https://cdn.jsdelivr.net/npm/world-countries@4/countries.geo.json',
        'https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson',
        'https://unpkg.com/@geo-maps/countries-land-1m@1.0.2/countries-land-1m.geo.json'
      ];
      for(const src of sources){
        try{ const r=await fetch(src,{mode:'cors'}); if(!r.ok) throw 0; const j=await r.json(); if(j && j.features && j.features.length>100){ worldGeo=j; break; } }catch(e){}
      }
      if(!worldGeo){ console.error('World polygons failed to load'); return; }

      // build centroid map + normalized key on features
      centroidByKey={};
      L.geoJSON(worldGeo).eachLayer(l=>{
        const p=l.feature&&l.feature.properties||{};
        const nmRaw=p.name||p.NAME||p.NAME_EN||p.ADMIN||p.SOVEREIGNT;
        if(!nmRaw) return;
        const nm=normalizeCountry(nmRaw);
        centroidByKey[nm]=CENTROID_OVERRIDES.has(nm)?L.latLng(...CENTROID_OVERRIDES.get(nm)):centroidInside(l.feature);
        if(l.feature.properties) l.feature.properties._key=nm;
      });

      // outline
      outlineLayer = L.geoJSON(worldGeo, {
        style:{ color:getCSS('--mint'), weight:0.6, opacity:0.35, fill:false }
      }).addTo(map);

      // shading (implemented only; style set after we know which)
      shadeLayer = L.geoJSON(worldGeo, {
        style: f => ({ color:'#0000', weight:0, fillColor:getCSS('--red'), fillOpacity:0 })
      }).addTo(map);

      // hit polygons (transparent but clickable)
      hitLayer = L.geoJSON(worldGeo, {
        style: { className:'country-hit', stroke:false, fill:true, fillColor:'#000', fillOpacity:0.01 },
        interactive:true,
        onEachFeature:(f,layer)=>{
          const key=(f.properties&&f.properties._key)||'';
          const open=()=>openCountryPopup(key);
          layer.on('click',open);
          layer.on('touchstart',e=>{e.originalEvent.preventDefault(); open();});
          layer.on('mouseover',()=>layer.setStyle({stroke:true,color:getCSS('--mint'),weight:1,opacity:.6}));
          layer.on('mouseout', ()=>layer.setStyle({stroke:false}));
        }
      }).addTo(map);

      // 2) sheet rows (with fallback)
      const text = await fetchCsvOrFallback(`${CSV_URL}${CSV_URL.includes('?')?'&':'?'}cb=${Date.now()}`);
      const parsed=Papa.parse(text,{header:true,skipEmptyLines:true});
      const rows=parsed.data;

      // 3) normalize
      entries=[];
      for(const row of rows){
        const title=String(row["Title"]||"").trim();
        const status=String(row["Status"]||"").trim();
        const notes =String(row["Description"]||"").trim();
        const year  =/^\d{4}$/.test(String(row["Year"]||"").trim())?parseInt(row["Year"]):null;
        const countriesCell=String(row["Countries"]||"").trim();
        if(!countriesCell) continue;

        for(const raw of splitCountries(countriesCell)){
          const key=normalizeCountry(raw);
          const alt=key.replace(/^(republic|kingdom)\sof\s/,'' ).trim();
          const pt=centroidByKey[key]||centroidByKey[alt];
          if(!pt) continue;
          const isImplemented=/implement/i.test(status);
          const isDev=/develop|discussion|pilot|trial|poc|concept/i.test(status);
          entries.push({key,country:titleCase(key),lat:pt.lat,lng:pt.lng,status,isImplemented,isDev,title,notes,year});
        }
      }

      drawAll(); // dots, lines, shading

      // --- Simple runtime tests ---
      console.assert(entries.length > 0, '[TEST] entries should not be empty');
      console.assert(dotsLayer.getLayers().length > 0, '[TEST] dots should be rendered');
      console.log('[TEST] Rendered dots:', dotsLayer.getLayers().length);
    })();

    function drawAll(){
      // Clear
      dotsLayer.clearLayers();
      linesImpLayer.clearLayers();
      linesDevLayer.clearLayers();

      const red=getCSS('--red'), orange=getCSS('--orange');

      // Deduplicate per country; prefer implemented if both exist
      const bestByKey=new Map();
      for(const e of entries){
        const prev=bestByKey.get(e.key);
        if(!prev || (e.isImplemented && !prev.isImplemented)) bestByKey.set(e.key,e);
      }

      // Separate lists for lines
      const impPts=[], devPts=[];
      const implementedShown = new Set();

      // Draw dots
      for(const [key,e] of bestByKey){
        const color=e.isImplemented?red:orange;
        L.circleMarker([e.lat,e.lng],{
          renderer:dotsRenderer, radius:6.5, color:darken(color,30), weight:1.2, fillColor:color, fillOpacity:.95
        })
        .bindTooltip(`${e.country}`,{direction:'top',offset:[0,-6]})
        .on('click',()=>openCountryPopup(key))
        .addTo(dotsLayer);

        if(e.isImplemented){ impPts.push([e.lat,e.lng]); implementedShown.add(key); }
        else               { devPts.push([e.lat,e.lng]); }
      }

      // Shade implemented countries that have dots
      if (shadeLayer){
        const fill = getCSS('--red');
        shadeLayer.setStyle(f=>{
          const k=(f.properties&&f.properties._key)||'';
          return implementedShown.has(k)
            ? {fillColor:fill, fillOpacity:0.14, color:'#0000', weight:0}
            : {fillOpacity:0, color:'#0000', weight:0};
        });
      }

      // Local networks: connect to K=3 nearest neighbors
      const K=3;
      buildLocalNetwork(impPts, getCSS('--red'),   linesImpLayer, K, .35, 1.2);
      buildLocalNetwork(devPts, getCSS('--orange'),linesDevLayer, K, .30, 1.1);
    }

    function buildLocalNetwork(coords, color, layer, k=3, opacity=.35, weight=1.2){
      const n=coords.length; if(n<2) return;
      const seen=new Set();
      for(let i=0;i<n;i++){
        const dists=[];
        for(let j=0;j<n;j++){
          if(i===j) continue;
          dists.push({j, d:haversine(coords[i],coords[j])});
        }
        dists.sort((a,b)=>a.d-b.d);
        const limit=Math.min(k, dists.length);
        for(let t=0;t<limit;t++){
          const j=dists[t].j, key=i<j?`${i}-${j}`:`${j}-${i}`; if(seen.has(key)) continue; seen.add(key);
          L.polyline([coords[i], coords[j]], { color, weight, opacity, smoothFactor:1 }).addTo(layer);
        }
      }
    }
  </script>
</body>
</html>
