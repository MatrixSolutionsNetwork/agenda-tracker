<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Matrix Solutions Network — Digital ID</title>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- CSV -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Turf (centroid fallback) -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <style>
    :root{
      --bg:#07100b; --text:#ffffff;
      --orange:#ff9900; --red:#ff3333; --mint:#7be2b1; --matrix:#21ff9d;
      --barPadY:16px; --barPadX:16px; --dynBarH: 92px;
      --countryText:#dfffe9;
    }

    html,body{
      height:100%;margin:0;
      background:radial-gradient(1200px 800px at 30% 10%, #0b2217 0%, #081911 35%, #06140f 70%, #05100c 100%);
      color:var(--text);
      font-family:"Share Tech Mono",ui-monospace,monospace;
    }

    /* ===== Top bar ===== */
    #topbar{
      position:fixed; z-index:1100; left:0; right:0; top:0;
      padding:var(--barPadY) var(--barPadX);
      background:linear-gradient(180deg,rgba(10,30,20,.70),rgba(8,22,16,.86));
      border-bottom:1px solid rgba(11,42,28,.6);
      box-shadow:0 10px 28px rgba(0,0,0,.45);
      backdrop-filter: blur(3px);
      display:flex; flex-direction:column; align-items:center; gap:8px;
      pointer-events: auto;
    }
    #brandWrap{display:flex; flex-direction:column; align-items:center; gap:6px; text-align:center;}
    .msn{color:var(--matrix)}
    #rowStatus{display:flex; align-items:center; gap:8px}
    #pageTitle{color:#fff}
    .live{font-size:11px;color:#ffffff;background:var(--red);padding:3px 8px;border-radius:999px;border:1px solid #ff6b6b}
    .updated{opacity:.9;font-size:12px}
    .inline-hint{opacity:.85;font-size:12px}

    /* ===== Map ===== */
    #map{
      position:absolute; left:0; right:0; top:var(--dynBarH); bottom:0;
      background:#000; /* ensure no green/gradient shows through */
    }
    .leaflet-container{ background:#000; }
    .leaflet-tile{ background:transparent; transform:translateZ(0); }
    .leaflet-tile { filter: brightness(1.08) contrast(1.08) saturate(0.95); }
    .leaflet-top{ top:12px; }
    .leaflet-labelsPane-pane img { filter: brightness(1.6) contrast(1.25); }

    /* Popup / tooltip */
    .leaflet-popup-content-wrapper{background:#0a1c14;color:#ffffff;border:1px solid #174d35;}
    .leaflet-popup-tip{background:#0a1c14;border:1px solid #174d35;}
    .leaflet-tooltip{background:#0a1c14;border:1px solid #174d35;color:var(--countryText) !important;}

    /* Transparent country hit polygons must accept events */
    .country-hit.leaflet-interactive{ pointer-events:auto !important; cursor:pointer; }

    /* Small on-screen error, if init blows up */
    #err {
      position: fixed; left: 12px; bottom: 12px; z-index: 1200;
      background:#2a0f0f; color:#ffd9d9; border:1px solid #8a3a3a;
      padding:8px 10px; border-radius:8px; font-size:12px; display:none;
    }
  </style>
</head>
<body>
  <div id="topbar">
    <div id="brandWrap">
      <div class="msn">Matrix Solutions Network</div>
      <div id="rowStatus">
        <span id="pageTitle">Digital ID Status</span>
        <span class="live">LIVE</span>
      </div>
      <div class="updated" id="updatedTop">Updated: …</div>
      <div class="inline-hint">• Click any dot or country for details</div>
    </div>
  </div>

  <div id="map" aria-label="Digital ID world map"></div>
  <div id="err"></div>

  <script>
    (function(){
      try {
        /* ===== CONFIG ===== */
        var SHEET_PUBLISHED_LINK =
          "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsoZwmLz701G4Q5zFjGsL_RO8yjfxe4jY0woh-YL_-ATX6Mc4Rzxf3cSP7LzLN9OCt5Is_s1FHHAWs/pub?gid=0&single=true&output=csv";

        // Local CSV fallback so the app still runs if fetch is blocked
        var FALLBACK_CSV = "Title,Status,Description,Year,Countries\n"
          + "National eID,Implemented,Live national digital identity,2023,United Kingdom\n"
          + "Digital ID Pilot,In development,Phase 2 pilot,2025,United States\n"
          + "MyKad,Implemented,Malaysia ID,2012,Malaysia\n"
          + "DNIe,Implemented,Spain smart ID,2016,Spain";

        function toCsvUrl(u){
          if (!u) return u;
          if (/output=csv/i.test(u)) return u;
          if (/\/pubhtml/i.test(u)){
            var url=new URL(u); url.pathname=url.pathname.replace(/\/pubhtml/i,"/pub");
            url.searchParams.set("output","csv");
            if(!url.searchParams.has("single")) url.searchParams.set("single","true");
            return url.toString();
          }
          if (/\/spreadsheets\/d\//i.test(u)){
            var m=u.match(/\/spreadsheets\/d\/([^/]+)/i);
            if(m){
              var id=m[1];
              var url2=new URL("https://docs.google.com/spreadsheets/d/"+id+"/export");
              url2.searchParams.set("format","csv");
              return url2.toString();
            }
          }
          return u;
        }
        var CSV_URL = toCsvUrl(SHEET_PUBLISHED_LINK);

        var COUNTRY_ALIASES = new Map([
          ["usa","united states"],["u.s.a.","united states"],["u.s.","united states"],["us","united states"],["united states of america","united states"],
          ["uk","united kingdom"],["england","united kingdom"],["scotland","united kingdom"],["wales","united kingdom"],["northern ireland","united kingdom"],
          ["uae","united arab emirates"],["u.a.e.","united arab emirates"],
          ["türkiye","turkey"],["turkiye","turkey"],
          ["republic of korea","south korea"],["korea (republic of)","south korea"],
          ["ivory coast","cote d ivoire"],["côte d’ivoire","cote d ivoire"],["cote d'ivoire","cote d ivoire"],
          ["czech republic","czechia"],["swaziland","eswatini"],["burma","myanmar"],
          ["macedonia","north macedonia"],["lao pdr","laos"],
          ["democratic republic of congo","democratic republic of the congo"],["drc","democratic republic of the congo"],
          ["russian federation","russia"],["viet nam","vietnam"],["iran (islamic republic of)","iran"],
          ["bolivia (plurinational state of)","bolivia"],["brunei darussalam","brunei"],
          ["republic of serbia","serbia"],["canada (ca)","canada"],["united states (us)","united states"]
        ]);

        var CENTROID_OVERRIDES = new Map([
          ["norway",[60.4720,8.4689]],["russia",[61.5240,105.3188]],["new zealand",[-41,172]],
          ["chile",[-35.6751,-71.5430]],["mauritius",[-20.2,57.5]],["spain",[40.4168,-3.7038]],
          ["italy",[42.5,12.5]],["denmark",[56.2639,9.5019]],["united kingdom",[52.3555,-1.1743]],
          ["serbia",[44.0165,21.0059]],["united states",[39.8283,-98.5795]],["canada",[56.1304,-106.3468]],
          ["costa rica",[9.7489,-83.7534]],["japan",[36.2048,138.2529]],["malaysia",[4.2105,101.9758]]
        ]);

        function normalizeCountry(s){
          var k=String(s||"").normalize('NFD').replace(/[\u0300-\u036f]/g,'')
            .replace(/[^a-z0-9 ]+/gi,' ').replace(/\s+/g,' ').toLowerCase().trim();
          return COUNTRY_ALIASES.get(k)||k;
        }
        function splitCountries(cell){
          return String(cell).replace(/・/g,',').split(/\s*(?:,|;|\/|&|\band\b)\s*/i).map(function(s){return s.trim();}).filter(Boolean);
        }
        function titleCase(s){return String(s).split(' ').map(function(w){return w? w[0].toUpperCase()+w.slice(1):'';}).join(' ');}
        function escapeHtml(str){return String(str).replace(/[&<>"']/g, function(s){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s];});}
        function getCSS(name){return getComputedStyle(document.documentElement).getPropertyValue(name).trim();}
        function darken(hex,amt){var n=parseInt(hex.replace('#',''),16);var r=(n>>16)-amt,g=((n>>8)&255)-amt,b=(n&255)-amt;r=Math.max(0,Math.min(255,r));g=Math.max(0,Math.min(255,g));b=Math.max(0,Math.min(255,b));return '#'+(b|(g<<8)|(r<<16)).toString(16).padStart(6,'0');}
        function haversine(a,b){var toRad=function(d){return d*Math.PI/180;},R=6371;var dLat=toRad(b[0]-a[0]),dLng=toRad(b[1]-a[1]);var s1=Math.sin(dLat/2)**2+Math.cos(toRad(a[0]))*Math.cos(toRad(b[0]))*Math.sin(dLng/2)**2;return 2*R*Math.asin(Math.sqrt(s1));}

        /* ===== Layout (bar height -> map top) ===== */
        var topbar=document.getElementById('topbar');
        function placeMap(){ var h=topbar.offsetHeight; document.documentElement.style.setProperty('--dynBarH', h+'px'); if(map) setTimeout(function(){ map.invalidateSize(); },0); }
        window.addEventListener('load',placeMap);
        window.addEventListener('resize',placeMap);
        if (document.fonts && document.fonts.ready) { document.fonts.ready.then(placeMap); }
        if (window.ResizeObserver) { new ResizeObserver(placeMap).observe(topbar); }
        window.addEventListener('orientationchange', function(){ setTimeout(placeMap, 250); }, {passive:true});
        document.addEventListener('visibilitychange', function(){ if (!document.hidden) setTimeout(placeMap, 150); });

        /* ===== Map & panes ===== */
        var map = L.map('map',{zoomControl:true,preferCanvas:false}).setView([20,0],2);

        // custom panes
        map.createPane('dotsPane');   map.getPane('dotsPane').style.zIndex = 650;
        map.createPane('labelsPane'); map.getPane('labelsPane').style.zIndex = 450;
        map.getPane('labelsPane').style.pointerEvents = 'none';

        // --- Robust basemap with fallbacks to avoid the “green map” ---
        var TILE_OPTS = {
          subdomains: 'abcd',
          maxZoom: 8,
          errorTileUrl: 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='
        };

        var baseNoLabels = L.tileLayer(
          'https://{s}.basemaps.cartocdn.com/rastertiles/dark_nolabels/{z}/{x}/{y}{r}.png',
          { subdomains:TILE_OPTS.subdomains, maxZoom:TILE_OPTS.maxZoom, errorTileUrl:TILE_OPTS.errorTileUrl, attribution:'&copy; OpenStreetMap &copy; CARTO' }
        ).addTo(map);

        var labelsOnly = L.tileLayer(
          'https://{s}.basemaps.cartocdn.com/rastertiles/dark_only_labels/{z}/{x}/{y}{r}.png',
          { subdomains:TILE_OPTS.subdomains, maxZoom:TILE_OPTS.maxZoom, errorTileUrl:TILE_OPTS.errorTileUrl, pane: 'labelsPane' }
        ).addTo(map);

        (function installTileFallback(primary, overlay){
          var switched = false;
          function switchToFallback(){
            if (switched) return; switched = true;
            if (map.hasLayer(primary)) map.removeLayer(primary);
            if (overlay && map.hasLayer(overlay)) map.removeLayer(overlay);

            var fallback1 = L.tileLayer(
              'https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png',
              { subdomains:TILE_OPTS.subdomains, maxZoom:TILE_OPTS.maxZoom, errorTileUrl:TILE_OPTS.errorTileUrl, attribution:'&copy; OpenStreetMap &copy; CARTO' }
            ).addTo(map);

            var switched2 = false;
            fallback1.on('tileerror', function(){
              if (switched2) return; switched2 = true;
              if (map.hasLayer(fallback1)) map.removeLayer(fallback1);
              L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                subdomains:'abc', maxZoom:TILE_OPTS.maxZoom, errorTileUrl:TILE_OPTS.errorTileUrl, attribution:'&copy; OpenStreetMap contributors'
              }).addTo(map);
            });

            setTimeout(function(){
              if (!switched2 && Object.keys(fallback1._tiles || {}).length === 0) {
                fallback1.fire('tileerror');
              }
            }, 3000);
          }
          primary.on('tileerror', switchToFallback);
          if (overlay) overlay.on('tileerror', switchToFallback);
          setTimeout(function(){
            var loaded = Object.keys(primary._tiles || {}).length + (overlay ? Object.keys(overlay._tiles || {}).length : 0);
            if (!switched && loaded === 0) switchToFallback();
          }, 3500);
        })(baseNoLabels, labelsOnly);

        var linesImpLayer = L.layerGroup().addTo(map);
        var linesDevLayer = L.layerGroup().addTo(map);
        var dotsLayer     = L.layerGroup().addTo(map);
        var outlineLayer=null, shadeLayer=null, hitLayer=null;

        /* ===== Data + interactions ===== */
        var worldGeo=null, centroidByKey={}, entries=[];

        function centroidInside(feature){
          try{ var c=turf.centerOfMass(feature).geometry.coordinates; return L.latLng(c[1],c[0]); }
          catch(e){ return L.geoJSON(feature).getBounds().getCenter(); }
        }
        function popupHTML(country, rows){
          var list = rows.map(function(r){
            var b=[]; if(r.title)b.push("<strong>Program:</strong> "+escapeHtml(r.title));
            if(r.status)b.push("<strong>Status:</strong> "+escapeHtml(r.status));
            if(Number.isInteger(r.year))b.push("<strong>Year:</strong> "+r.year);
            if(r.notes)b.push("<span style=\"opacity:.8\">"+escapeHtml(r.notes)+"</span>");
            return "<div style=\"margin-bottom:8px\">"+b.join("<br>")+"</div>";
          }).join('');
          return "<div style=\"min-width:240px\"><h3 style=\"margin:0 0 6px 0; font-size:16px;color:"+getCSS('--countryText')+"\">"+escapeHtml(country)+"</h3>"+list+"</div>";
        }
        function openCountryPopup(countryKey){
          if(!countryKey) return;
          var rows=entries.filter(function(e){return e.key===countryKey;});
          var pt=centroidByKey[countryKey];
          if(!pt) return;
          var html=rows.length?popupHTML(rows[0].country,rows):"<div style=\"min-width:240px;\">No record in dataset.</div>";
          L.popup({autoClose:true, closeOnClick:true}).setLatLng(pt).setContent(html).openOn(map);
        }

        function fetchCsvOrFallback(url, timeoutMs){
          if (!timeoutMs) timeoutMs = 7000;
          return new Promise(function(resolve){
            var ctrl = new AbortController(), timer = setTimeout(function(){ try{ctrl.abort();}catch(_){} }, timeoutMs);
            fetch(url, { cache:'no-store', mode:'cors', signal: ctrl.signal })
              .then(function(res){
                clearTimeout(timer);
                if(!res.ok) throw new Error("Bad status "+res.status);
                var dateHdr = res.headers.get('Date') || new Date().toUTCString();
                document.getElementById('updatedTop').textContent = 'Updated: ' + dateHdr;
                return res.text();
              })
              .then(function(text){ resolve(text); })
              .catch(function(){
                document.getElementById('updatedTop').textContent = 'Updated: Local sample data';
                resolve(FALLBACK_CSV);
              });
          });
        }

        (async function init(){
          // 1) world polygons
          var sources=[
            'https://cdn.jsdelivr.net/npm/world-countries@4/countries.geo.json',
            'https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson',
            'https://unpkg.com/@geo-maps/countries-land-1m@1.0.2/countries-land-1m.geo.json'
          ];
          for(var i=0;i<sources.length;i++){
            try{
              var r=await fetch(sources[i],{mode:'cors'});
              if(!r.ok) throw 0; var j=await r.json();
              if(j && j.features && j.features.length>100){ worldGeo=j; break; }
            }catch(e){}
          }
          if(!worldGeo){ showErr('World polygons failed to load (network/CORS). Dots will still show when CSV loads.'); }

          // build centroid map + normalized key on features
          if (worldGeo){
            centroidByKey={};
            L.geoJSON(worldGeo).eachLayer(function(l){
              var p=l.feature&&l.feature.properties||{};
              var nmRaw=p.name||p.NAME||p.NAME_EN||p.ADMIN||p.SOVEREIGNT;
              if(!nmRaw) return;
              var nm=normalizeCountry(nmRaw);
              if(CENTROID_OVERRIDES.has(nm)){
                var ov=CENTROID_OVERRIDES.get(nm); centroidByKey[nm]=L.latLng(ov[0],ov[1]);
              } else {
                centroidByKey[nm]=centroidInside(l.feature);
              }
              if(l.feature.properties) l.feature.properties._key=nm;
            });

            // outline
            outlineLayer = L.geoJSON(worldGeo, {
              style:{ color:getCSS('--mint'), weight:0.6, opacity:0.35, fill:false }
            }).addTo(map);

            // shading (implemented only; style set after we know which)
            shadeLayer = L.geoJSON(worldGeo, {
              style: function(){ return { color:'#0000', weight:0, fillColor:getCSS('--red'), fillOpacity:0 }; }
            }).addTo(map);

            // hit polygons (transparent but clickable) BELOW dots (default pane < dotsPane)
            hitLayer = L.geoJSON(worldGeo, {
              style: { className:'country-hit', stroke:false, fill:true, fillColor:'#000', fillOpacity:0.01 },
              interactive:true,
              onEachFeature:function(f,layer){
                var key=(f.properties&&f.properties._key)||'';
                var open=function(){ openCountryPopup(key); };
                layer.on('click',open);
                layer.on('touchstart',function(e){ if(e && e.originalEvent) e.originalEvent.preventDefault(); open();});
                layer.on('mouseover',function(){ layer.setStyle({stroke:true,color:getCSS('--mint'),weight:1,opacity:.6}); });
                layer.on('mouseout', function(){ layer.setStyle({stroke:false}); });
              }
            }).addTo(map);
          }

          // 2) sheet rows (with fallback)
          var text = await fetchCsvOrFallback(CSV_URL + (CSV_URL.indexOf('?')>-1?'&':'?') + 'cb=' + Date.now());
          var parsed=Papa.parse(text,{header:true,skipEmptyLines:true});
          var rows=parsed.data;

          // 3) normalize
          entries=[];
          for(var ri=0; ri<rows.length; ri++){
            var row = rows[ri];
            var title=String(row["Title"]||"").trim();
            var status=String(row["Status"]||"").trim();
            var notes =String(row["Description"]||"").trim();
            var year  =/^\d{4}$/.test(String(row["Year"]||"").trim())?parseInt(row["Year"]):null;
            var countriesCell=String(row["Countries"]||"").trim();
            if(!countriesCell) continue;

            var toks = splitCountries(countriesCell);
            for(var ti=0; ti<toks.length; ti++){
              var key=normalizeCountry(toks[ti]);
              var alt=key.replace(/^(republic|kingdom)\sof\s/,'').trim();
              var pt=(centroidByKey && (centroidByKey[key]||centroidByKey[alt])) || null;
              if(!pt) continue;
              var isImplemented=/implement/i.test(status);
              var isDev=/develop|discussion|pilot|trial|poc|concept/i.test(status);
              entries.push({key:key,country:titleCase(key),lat:pt.lat,lng:pt.lng,status:status,isImplemented:isImplemented,isDev:isDev,title:title,notes:notes,year:year});
            }
          }

          drawAll(); // dots, lines, shading
          console.assert(entries.length > 0, '[TEST] entries should not be empty');
          console.assert(dotsLayer.getLayers().length > 0, '[TEST] dots should be rendered');
        })();

        function drawAll(){
          dotsLayer.clearLayers();
          linesImpLayer.clearLayers();
          linesDevLayer.clearLayers();

          var red=getCSS('--red'), orange=getCSS('--orange');

          // Deduplicate per country; prefer implemented
          var bestByKey=new Map();
          for(var i=0;i<entries.length;i++){
            var e=entries[i], prev=bestByKey.get(e.key);
            if(!prev || (e.isImplemented && !prev.isImplemented)) bestByKey.set(e.key,e);
          }

          var impPts=[], devPts=[];
          var implementedShown = new Set();

          bestByKey.forEach(function(e, key){
            var color=e.isImplemented?red:orange;
            L.circleMarker([e.lat,e.lng],{
              // renderer default (SVG) to preserve click-through to country polygons
              pane:'dotsPane',
              radius:6.5, color:darken(color,30), weight:1.2, fillColor:color, fillOpacity:.95
            })
            .bindTooltip(e.country,{direction:'top',offset:[0,-6]})
            .on('click',function(){ openCountryPopup(key); })
            .addTo(dotsLayer);

            if(e.isImplemented){ impPts.push([e.lat,e.lng]); implementedShown.add(key); }
            else               { devPts.push([e.lat,e.lng]); }
          });

          if (shadeLayer){
            var fill = getCSS('--red');
            shadeLayer.setStyle(function(f){
              var k=(f.properties&&f.properties._key)||'';
              return implementedShown.has(k)
                ? {fillColor:fill, fillOpacity:0.14, color:'#0000', weight:0}
                : {fillOpacity:0, color:'#0000', weight:0};
            });
          }

          var K=3;
          buildLocalNetwork(impPts, getCSS('--red'),   linesImpLayer, K, .35, 1.2);
          buildLocalNetwork(devPts, getCSS('--orange'),linesDevLayer, K, .30, 1.1);
        }

        function buildLocalNetwork(coords, color, layer, k, opacity, weight){
          if(k==null) k=3; if(opacity==null) opacity=.35; if(weight==null) weight=1.2;
          var n=coords.length; if(n<2) return;
          var seen=new Set();
          for(var i=0;i<n;i++){
            var dists=[];
            for(var j=0;j<n;j++){
              if(i===j) continue;
              dists.push({j:j, d:haversine(coords[i],coords[j])});
            }
            dists.sort(function(a,b){return a.d-b.d;});
            var limit=Math.min(k, dists.length);
            for(var t=0;t<limit;t++){
              var jj=dists[t].j, key=i<jj? (i+"-"+jj) : (jj+"-"+i); if(seen.has(key)) continue; seen.add(key);
              L.polyline([coords[i], coords[jj]], { color:color, weight:weight, opacity:opacity, smoothFactor:1 }).addTo(layer);
            }
          }
        }

        function showErr(msg){
          var el = document.getElementById('err');
          el.textContent = msg;
          el.style.display = 'block';
        }
      } catch (e){
        console.error(e);
        var el = document.getElementById('err');
        if (el){ el.textContent = 'Init error: '+ e.message; el.style.display='block'; }
      }
    })();
  </script>
</body>
</html>
