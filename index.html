<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Matrix Solutions Network — Digital ID Dots</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- CSV parsing -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg:#0b0f12; --text:#e6f3ea; --muted:#8aa39a;
      --panel:#0f1418; --panelEdge:#151b21;
      --orange:#ff9900; /* In development / discussion */
      --red:#ff3333;    /* Implemented */
      --other:#5ec1ff;  /* anything else */
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);}
    #map{height:100%;width:100%}

    .panel{
      position:absolute; top:12px; left:12px; z-index:1000;
      background:linear-gradient(180deg,rgba(21,27,33,.92),rgba(15,20,24,.94));
      border:1px solid var(--panelEdge); border-radius:12px;
      padding:12px 14px; width:300px; font:14px/1.4 ui-sans-serif,system-ui;
      box-shadow:0 6px 18px rgba(0,0,0,.45);
    }
    .panel h2{margin:0 0 8px 0; font-size:15px;}
    .row{display:flex;align-items:center;gap:8px;margin:4px 0;}
    .sw{width:12px;height:12px;border-radius:50%}
    .count{margin-left:auto;color:var(--muted);font-weight:700}
    .hr{border:none;border-top:1px solid #182126;margin:8px 0}
    .debug{margin-top:8px;max-height:120px;overflow:auto;font-size:12px;color:#9ab3a8;display:none}
    .leaflet-popup-content-wrapper{background:#0e1512;color:var(--text);border:1px solid #1b3a2e;}
    .leaflet-popup-tip{background:#0e1512;border:1px solid #1b3a2e;}
    .leaflet-tooltip{background:#0e1512;color:var(--text);border:1px solid #1b3a2e;}
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <h2>Status Overview</h2>
    <div class="row"><span class="sw" style="background:var(--red)"></span> Implemented <span class="count" id="c-imp">0</span></div>
    <div class="row"><span class="sw" style="background:var(--orange)"></span> In development / discussion <span class="count" id="c-dev">0</span></div>
    <div class="row"><span class="sw" style="background:var(--other)"></span> Other <span class="count" id="c-oth">0</span></div>
    <div class="hr"></div>
    <div class="debug" id="debug"></div>
    <div style="font-size:12px;color:var(--muted);margin-top:6px">Data loads from your Google Sheet (CSV). Click a dot for details.</div>
  </div>

  <script>
    /* === CONFIG === */
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsoZwmLz701G4Q5zFjGsL_RO8yjfxe4jY0woh-YL_-ATX6Mc4Rzxf3cSP7LzLN9OCt5Is_s1FHHAWs/pub?gid=0&single=true&output=csv";

    // Minimal alias table for common variants/abbreviations
    const COUNTRY_ALIASES = new Map([
      ["usa","united states"], ["u.s.a.","united states"], ["united states of america","united states"],
      ["uk","united kingdom"], ["england","united kingdom"], ["scotland","united kingdom"],
      ["wales","united kingdom"], ["northern ireland","united kingdom"], ["great britain","united kingdom"],
      ["uae","united arab emirates"], ["u.a.e.","united arab emirates"],
      ["türkiye","turkey"], ["turkiye","turkey"],
      ["republic of korea","south korea"], ["korea (republic of)","south korea"], ["korea, south","south korea"],
      ["ivory coast","cote d ivoire"], ["côte d’ivoire","cote d ivoire"], ["cote d'ivoire","cote d ivoire"],
      ["czech republic","czechia"], ["swaziland","eswatini"], ["burma","myanmar"],
      ["macedonia","north macedonia"], ["lao pdr","laos"],
      ["democratic republic of congo","democratic republic of the congo"], ["drc","democratic republic of the congo"],
      ["congo, democratic republic of the","democratic republic of the congo"],
      ["russian federation","russia"], ["viet nam","vietnam"], ["iran (islamic republic of)","iran"],
      ["bolivia (plurinational state of)","bolivia"], ["brunei darussalam","brunei"]
    ]);

    // Color rules: red for Implemented; orange for anything that looks like "in dev/discussion"; else blue.
    function colorForStatus(s){
      const k = String(s||"").toLowerCase();
      if (k.includes("implement")) return getCSS("--red");
      if (k.includes("in development") || k.includes("in discussion") || k.includes("discussion") || k.includes("develop")) return getCSS("--orange");
      return getCSS("--other");
    }

    /* === MAP === */
    const map = L.map('map', { zoomControl:true }).setView([20,0], 2);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png', {
      attribution:'&copy; OpenStreetMap &copy; CARTO', subdomains:'abcd', maxZoom:8
    }).addTo(map);
    const dots = L.layerGroup().addTo(map);

    (async function init(){
      // 1) Load polygons once to get country centroids
      const world = await fetch('https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson').then(r=>r.json());
      const centroids = {};
      L.geoJSON(world).eachLayer(l=>{
        const key = normalizeCountry(l.feature.properties.ADMIN);
        centroids[key] = l.getBounds().getCenter();
      });

      // 2) Load your sheet
      const rows = await loadSheet(CSV_URL);

      // 3) Expand multi-country cells into individual records and draw dots
      const counts = { imp:0, dev:0, other:0 };
      const unmatched = new Set();

      for (const r of rows){
        const countries = splitCountries(r.countryRaw);
        for (const cRaw of countries){
          const c = normalizeCountry(cRaw);
          const key = centroids[c] ? c : null;
          if (!key){ unmatched.add(cRaw); continue; }

          const color = colorForStatus(r.status);
          L.circleMarker(centroids[key], {
            radius: 6.5, color: darken(color,30), weight:1.2, fillColor: color, fillOpacity:.95
          })
          .bindTooltip(`${titleCase(c)}: ${r.status}`, {direction:'top', offset:[0,-6]})
          .bindPopup(popupHtml(titleCase(c), r))
          .addTo(dots);

          // counts
          const s = r.status.toLowerCase();
          if (s.includes("implement")) counts.imp++;
          else if (s.includes("develop") || s.includes("discussion")) counts.dev++;
          else counts.other++;
        }
      }

      document.getElementById('c-imp').textContent = counts.imp;
      document.getElementById('c-dev').textContent = counts.dev;
      document.getElementById('c-oth').textContent = counts.other;

      // 4) Show unmatched in panel (so you can add aliases if needed)
      if (unmatched.size){
        const dbg = document.getElementById('debug');
        dbg.style.display = 'block';
        dbg.innerHTML = `<b>Unmatched country tokens (add aliases or fix sheet):</b><br>${[...unmatched].sort().join(', ')}`;
        console.warn("Unmatched:", [...unmatched].sort());
      }
    })();

    /* === Helpers === */
    async function loadSheet(url){
      const res = await fetch(url, { cache:'no-store' });
      const text = await res.text();
      const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });
      // Expecting headers: Countries, Title, Status, Description
      return parsed.data.map(row => ({
        countryRaw: String(row["Countries"]||"").trim(),
        title:      String(row["Title"]||"").trim(),
        status:     String(row["Status"]||"").trim(),
        notes:      String(row["Description"]||"").trim()
      })).filter(r => r.countryRaw);
    }

    function splitCountries(cell){
      // Split on comma/semicolon/slash/&/‘and’; keep tokens clean
      return String(cell)
        .replace(/・/g, ',') // just in case
        .split(/\s*(?:,|;|\/|&|\band\b)\s*/i)
        .map(s=>s.trim())
        .filter(Boolean);
    }

    function normalizeCountry(s){
      const k = String(s||"")
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/[^a-z0-9 ]+/gi,' ')
        .replace(/\s+/g,' ')
        .toLowerCase().trim();
      const aliased = COUNTRY_ALIASES.get(k) || k;
      return aliased;
    }

    function popupHtml(countryName, rec){
      return `
        <div style="min-width:240px">
          <h3 style="margin:0 0 6px 0; font-size:16px;">${escapeHtml(countryName)}</h3>
          ${rec.title ? `<div><strong>Program:</strong> ${escapeHtml(rec.title)}</div>` : ""}
          ${rec.status ? `<div><strong>Status:</strong> ${escapeHtml(rec.status)}</div>` : ""}
          ${rec.notes ? `<div style="margin-top:6px;color:${getCSS('--muted')}">${escapeHtml(rec.notes)}</div>` : ""}
        </div>
      `;
    }

    function titleCase(s){ return String(s).split(' ').map(w=>w? w[0].toUpperCase()+w.slice(1):'').join(' '); }
    function getCSS(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
    function darken(hex, amt){
      const n = parseInt(hex.replace('#',''),16);
      let r=(n>>16)+(-amt), g=((n>>8)&255)+(-amt), b=(n&255)+(-amt);
      r=Math.max(0,Math.min(255,r)); g=Math.max(0,Math.min(255,g)); b=Math.max(0,Math.min(255,b));
      return '#'+(b|(g<<8)|(r<<16)).toString(16).padStart(6,'0');
    }
    function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'}[s])); }
  </script>
</body>
</html>
