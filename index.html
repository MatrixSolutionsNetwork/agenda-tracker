<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Matrix Solutions Network — Digital ID Map</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Arcs plugin -->
  <script src="https://unpkg.com/leaflet-arc@1.0.0/dist/leaflet-arc.min.js"></script>

  <!-- PapaParse for CSV -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg:#0b0f12;
      --panel:#0f1418;
      --panelEdge:#151b21;
      --text:#e6f3ea;
      --muted:#8aa39a;
      --orange:#ff9900;   /* In Discussion */
      --red:#ff3333;      /* Implemented */
      --cyan:#35d3ff;     /* Pilot */
      --grey:#888888;     /* Abandoned */
      --neutral:#4b5563;
    }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--text); }
    #map { height:100%; width:100%; }

    .titlebar{
      position:absolute; top:16px; left:50%; transform:translateX(-50%);
      background:rgba(10,16,13,.85); color:#00ff95;
      padding:6px 12px; border-radius:10px; border:1px solid #163a2c;
      font:600 14px ui-sans-serif,system-ui; z-index:900;
      box-shadow:0 6px 18px rgba(0,0,0,.45);
    }
    .panel{
      position:absolute; top:16px; left:16px; z-index:1000;
      background:linear-gradient(180deg, rgba(21,27,33,.92), rgba(15,20,24,.94));
      border:1px solid var(--panelEdge); border-radius:14px;
      box-shadow:0 6px 18px rgba(0,0,0,.45);
      padding:14px 16px; width:260px;
      font:14px/1.4 ui-sans-serif,system-ui;
    }
    .panel h2{margin:0 0 10px 0; font-size:15px;}
    .legend .item{display:flex; align-items:center; gap:10px; margin:6px 0;}
    .swatch{width:12px; height:12px; border-radius:50%;}
    .count{margin-left:auto; font-weight:700; color:var(--muted);}
    .pill{font-weight:700; padding:2px 8px; border-radius:999px; background:#0a1210; border:1px solid #1b3a2e;}
    .leaflet-popup-content-wrapper{background:#0e1512; color:var(--text);}
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="titlebar">Matrix Solutions Network — Digital ID Map</div>

  <div class="panel">
    <h2>Status Overview</h2>
    <div class="legend">
      <div class="item"><span class="swatch" style="background:var(--red);"></span> Implemented <span class="count" id="c-imp">0</span></div>
      <div class="item"><span class="swatch" style="background:var(--orange);"></span> In Discussion <span class="count" id="c-disc">0</span></div>
      <div class="item"><span class="swatch" style="background:var(--cyan);"></span> Pilot <span class="count" id="c-pilot">0</span></div>
      <div class="item"><span class="swatch" style="background:var(--grey);"></span> Abandoned <span class="count" id="c-abnd">0</span></div>
    </div>
  </div>

  <script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsoZwmLz701G4Q5zFjGsL_RO8yjfxe4jY0woh-YL_-ATX6Mc4Rzxf3cSP7LzLN9OCt5Is_s1FHHAWs/pub?gid=0&single=true&output=csv";

    const STATUS_ALIASES = {
      "implemented":"Implemented",
      "in development":"In Discussion",
      "in discussion":"In Discussion",
      "pilot":"Pilot",
      "abandoned":"Abandoned"
    };

    const COLORS = {
      "Implemented":   "#ff3333", // red
      "In Discussion": "#ff9900", // orange
      "Pilot":         "#35d3ff",
      "Abandoned":     "#888888"
    };

    const map = L.map('map').setView([20,0],2);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png',
      {attribution:'&copy; OpenStreetMap &copy; CARTO',subdomains:'abcd'}
    ).addTo(map);

    async function loadCsv(){
      const res = await fetch(CSV_URL);
      const text = await res.text();
      const parsed = Papa.parse(text,{header:true,skipEmptyLines:true});
      return parsed.data.map(row=>({
        country:(row["Countries"]||"").trim(),
        program:(row["Title"]||"").trim(),
        status:normalizeStatus(row["Status"]),
        notes:(row["Description"]||"").trim()
      }));
    }

    function normalizeStatus(s){
      const k = (s||"").toLowerCase().trim();
      return STATUS_ALIASES[k] || s;
    }

    loadCsv().then(DATA=>{
      const counts={Implemented:0,"In Discussion":0,Pilot:0,Abandoned:0};
      DATA.forEach(d=>{if(counts[d.status]!=null) counts[d.status]++;});
      document.getElementById('c-imp').textContent=counts["Implemented"];
      document.getElementById('c-disc').textContent=counts["In Discussion"];
      document.getElementById('c-pilot').textContent=counts["Pilot"];
      document.getElementById('c-abnd').textContent=counts["Abandoned"];

      // Load geoJSON to find centroids
      fetch('https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson')
        .then(r=>r.json()).then(geo=>{
          let centroids={};
          L.geoJSON(geo).eachLayer(l=>{
            centroids[l.feature.properties.ADMIN.toLowerCase()]=l.getBounds().getCenter();
          });

          let implementedPoints=[];
          DATA.forEach(d=>{
            const c=centroids[d.country.toLowerCase()];
            if(!c) return;
            const color=COLORS[d.status]||"#999";
            const marker=L.circleMarker(c,{radius:6,color:color,fillColor:color,fillOpacity:0.9})
              .bindPopup(`<b>${d.country}</b><br>${d.status}<br>${d.program}<br>${d.notes}`);
            marker.addTo(map);
            if(d.status==="Implemented") implementedPoints.push(c);
          });

          // Draw red curved arcs between implemented countries
          for(let i=0;i<implementedPoints.length;i++){
            for(let j=i+1;j<implementedPoints.length;j++){
              const p1=implementedPoints[i], p2=implementedPoints[j];
              L.Polyline.Arc([p1.lat,p1.lng],[p2.lat,p2.lng],
                {color:"#ff3333",weight:1.2,opacity:0.6,dashArray:"4,6",vertices:200}
              ).addTo(map);
            }
          }
        });
    });
  </script>
</body>
</html>
