<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Matrix Solutions Network — Digital ID</title>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- CSV -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Turf (centroid fallback) -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <style>/* (identical CSS as above) */</style>
</head>
<body>
  <div id="topbar">
    <div id="brandWrap">
      <div class="msn">Matrix Solutions Network</div>
      <div id="rowStatus">
        <span id="pageTitle">Digital ID Status</span>
        <span class="live">LIVE</span>
      </div>
      <div class="updated" id="updatedTop">Updated: …</div>
      <div class="inline-hint">• Click any dot or country for details</div>
    </div>
  </div>

  <div id="map" aria-label="Digital ID world map"></div>

  <script>
    /* ===== PAGE VARS (only change these two for each tracker) ===== */
    const TRACKER_NAME = "Social Credit";
    const SHEET_PUBLISHED_LINK = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsoZwmLz701G4Q5zFjGsL_RO8yjfxe4jY0woh-YL_-ATX6Mc4Rzxf3cSP7LzLN9OCt5Is_s1FHHAWs/pub?gid=1564220601&single=true&output=csv";

    // Apply dynamic labels
    document.title = `Matrix Solutions Network — ${TRACKER_NAME}`;
    document.getElementById('pageTitle').textContent = `${TRACKER_NAME} Status`;
    document.getElementById('map').setAttribute('aria-label', `${TRACKER_NAME} world map`);
    const hintEl = document.querySelector('.inline-hint');
    if (hintEl) hintEl.textContent = `• Click any dot or country for ${TRACKER_NAME.toLowerCase()} details`;

    /* ===== CONFIG ===== */
    const FALLBACK_CSV = `Title,Status,Description,Year,Countries
City-level scoring,Pilot,Pilot cohort,2024,Italy
Travel sanctions,Implemented,Limited access policy,2023,China
Rewards program,In development,Credit multipliers,2025,Canada`;

    function toCsvUrl(u){
      if (!u) return u;
      if (/output=csv/i.test(u)) return u;
      if (/\/pubhtml/i.test(u)){ const url=new URL(u); url.pathname=url.pathname.replace(/\/pubhtml/i,"/pub"); url.searchParams.set("output","csv"); if(!url.searchParams.has("single")) url.searchParams.set("single","true"); return url.toString(); }
      if (/\/spreadsheets\/d\//i.test(u)){ const m=u.match(/\/spreadsheets\/d\/([^/]+)/i); if(m){ const id=m[1]; const url=new URL(`https://docs.google.com/spreadsheets/d/${id}/export`); url.searchParams.set("format","csv"); return url.toString(); } }
      return u;
    }
    const CSV_URL = toCsvUrl(SHEET_PUBLISHED_LINK);

    /* ===== rest of JS is identical to cbdc.html ===== */

    const COUNTRY_ALIASES = new Map([
      ["usa","united states"],["u.s.a.","united states"],["u.s.","united states"],["us","united states"],["united states of america","united states"],
      ["uk","united kingdom"],["england","united kingdom"],["scotland","united kingdom"],["wales","united kingdom"],["northern ireland","united kingdom"],
      ["uae","united arab emirates"],["u.a.e.","united arab emirates"],
      ["türkiye","turkey"],["turkiye","turkey"],
      ["republic of korea","south korea"],["korea (republic of)","south korea"],
      ["ivory coast","cote d ivoire"],["côte d’ivoire","cote d ivoire"],["cote d'ivoire","cote d ivoire"],
      ["czech republic","czechia"],["swaziland","eswatini"],["burma","myanmar"],
      ["macedonia","north macedonia"],["lao pdr","laos"],
      ["democratic republic of congo","democratic republic of the congo"],["drc","democratic republic of the congo"],
      ["russian federation","russia"],["viet nam","vietnam"],["iran (islamic republic of)","iran"],
      ["bolivia (plurinational state of)","bolivia"],["brunei darussalam","brunei"],
      ["republic of serbia","serbia"],["canada (ca)","canada"],["united states (us)","united states"]
    ]);
    const CENTROID_OVERRIDES = new Map([
      ["norway",[60.4720,8.4689]],["russia",[61.5240,105.3188]],["new zealand",[-41,172]],
      ["chile",[-35.6751,-71.5430]],["mauritius",[-20.2,57.5]],["spain",[40.4168,-3.7038]],
      ["italy",[42.5,12.5]],["denmark",[56.2639,9.5019]],["united kingdom",[52.3555,-1.1743]],
      ["serbia",[44.0165,21.0059]],["united states",[39.8283,-98.5795]],["canada",[56.1304,-106.3468]],
      ["costa rica",[9.7489,-83.7534]],["japan",[36.2048,138.2529]],["malaysia",[4.2105,101.9758]]
    ]);

    function titleCase(s){return String(s).split(' ').map(w=>w? w[0].toUpperCase()+w.slice(1):'').join(' ');}
    function escapeHtml(str){return String(str).replace(/[&<>"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s]));}
    function getCSS(name){return getComputedStyle(document.documentElement).getPropertyValue(name).trim();}
    function darken(hex,amt){const n=parseInt(hex.replace('#',''),16);let r=(n>>16)-amt,g=((n>>8)&255)-amt,b=(n&255)-amt;r=Math.max(0,Math.min(255,r));g=Math.max(0,Math.min(255,g));b=Math.max(0,Math.min(255,b));return '#'+(b|(g<<8)|(r<<16)).toString(16).padStart(6,'0');}
    function haversine(a,b){const toRad=d=>d*Math.PI/180,R=6371;const dLat=toRad(b[0]-a[0]),dLng=toRad(b[1]-a[1]);const s1=Math.sin(dLat/2)**2+Math.cos(toRad(a[0]))*Math.cos(toRad(b[0]))*Math.sin(dLng/2)**2;return 2*R*Math.asin(Math.sqrt(s1));}
    function splitCountries(cell){return String(cell).replace(/・/g,',').split(/\s*(?:,|;|\/|&|\band\b)\s*/i).map(s=>s.trim()).filter(Boolean);}
    function normalizeCountry(s){
      const k=String(s||"").normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9 ]+/gi,' ').replace(/\s+/g,' ').toLowerCase().trim();
      return COUNTRY_ALIASES.get(k)||k;
    }

    const map = L.map('map',{zoomControl:true,preferCanvas:true}).setView([20,0],2);
    map.createPane('labelsPane'); map.getPane('labelsPane').style.zIndex = 450; map.getPane('labelsPane').style.pointerEvents='none';
    map.createPane('hitPane');    map.getPane('hitPane').style.zIndex    = 500;
    map.createPane('linesPane');  map.getPane('linesPane').style.zIndex  = 600;
    map.createPane('dotsPane');   map.getPane('dotsPane').style.zIndex   = 650;

    const TILE_OPTS = { subdomains: 'abcd', maxZoom: 8, errorTileUrl: 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=' };
    let baseNoLabels = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/dark_nolabels/{z}/{x}/{y}{r}.png',{...TILE_OPTS,attribution:'&copy; OpenStreetMap &copy; CARTO'}).addTo(map);
    let labelsOnly  = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/dark_only_labels/{z}/{x}/{y}{r}.png',{...TILE_OPTS,pane:'labelsPane'}).addTo(map);
    installTileFallback(baseNoLabels, labelsOnly);
    function installTileFallback(primary, overlay) {
      let switched=false;
      function switchToFallback(){
        if (switched) return; switched=true;
        try{ if(map.hasLayer(primary)) map.removeLayer(primary); if(overlay&&map.hasLayer(overlay)) map.removeLayer(overlay);}catch(e){}
        const fallback1=L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png',{...TILE_OPTS,attribution:'&copy; OpenStreetMap &copy; CARTO'}).addTo(map);
        let switched2=false;
        fallback1.on('tileerror',()=>{ if(switched2) return; switched2=true; try{ if(map.hasLayer(fallback1)) map.removeLayer(fallback1);}catch(e){} L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{...TILE_OPTS,attribution:'&copy; OpenStreetMap contributors'}).addTo(map); });
        setTimeout(()=>{ if(!switched2 && Object.keys(fallback1._tiles||{}).length===0){ fallback1.fire('tileerror'); } },3000);
      }
      primary.on('tileerror',switchToFallback);
      if(overlay) overlay.on('tileerror',switchToFallback);
      setTimeout(()=>{ const loaded=Object.keys(primary._tiles||{}).length + (overlay?Object.keys(overlay._tiles||{}).length:0); if(!switched && loaded===0) switchToFallback(); },3500);
    }

    const dotsRenderer=L.canvas({pane:'dotsPane',padding:0.3});
    const linesRenderer=L.canvas({pane:'linesPane',padding:0.3});
    const linesImpLayer=L.layerGroup([], {pane:'linesPane'}).addTo(map);
    const linesDevLayer=L.layerGroup([], {pane:'linesPane'}).addTo(map);
    const dotsLayer=L.layerGroup([], {pane:'dotsPane'}).addTo(map);
    let outlineLayer=null, shadeLayer=null, hitLayer=null;

    const topbar=document.getElementById('topbar');
    function placeMap(){ const h=topbar.offsetHeight; document.documentElement.style.setProperty('--dynBarH', h+'px'); setTimeout(()=>map.invalidateSize(),0); }
    window.addEventListener('load',placeMap);
    window.addEventListener('resize',placeMap);
    if(document.fonts){document.fonts.ready.then(placeMap);}
    new ResizeObserver(placeMap).observe(topbar);
    window.addEventListener('orientationchange',()=>setTimeout(placeMap,250),{passive:true});
    document.addEventListener('visibilitychange',()=>{ if(!document.hidden) setTimeout(placeMap,150); });

    let worldGeo=null, centroidByKey={}, entries=[];

    function centroidInside(feature){ try{ const c=turf.centerOfMass(feature).geometry.coordinates; return L.latLng(c[1],c[0]); } catch(e){ return L.geoJSON(feature).getBounds().getCenter(); } }
    function popupHTML(country, rows){
      const list=rows.map(r=>{ const b=[]; if(r.title)b.push(`<strong>Program:</strong> ${escapeHtml(r.title)}`); if(r.status)b.push(`<strong>Status:</strong> ${escapeHtml(r.status)}`); if(Number.isInteger(r.year))b.push(`<strong>Year:</strong> ${r.year}`); if(r.notes)b.push(`<span style="opacity:.8">${escapeHtml(r.notes)}</span>`); return `<div style="margin-bottom:8px">${b.join('<br>')}</div>`; }).join('');
      return `<div style="min-width:240px"><h3 style="margin:0 0 6px 0; font-size:16px;color:${getCSS('--countryText')}">${escapeHtml(country)}</h3>${list}</div>`;
    }
    function openCountryPopup(countryKey){
      if(!countryKey) return;
      const rows=entries.filter(e=>e.key===countryKey);
      const pt=centroidByKey[countryKey];
      if(!pt) return;
      const html=rows.length?popupHTML(rows[0].country,rows):`<div style="min-width:240px;">No record in dataset.</div>`;
      L.popup({autoClose:true, closeOnClick:true}).setLatLng(pt).setContent(html).openOn(map);
    }

    async function fetchCsvOrFallback(url, timeoutMs=7000){
      try{
        const ctrl=new AbortController();
        const t=setTimeout(()=>ctrl.abort(),timeoutMs);
        const res=await fetch(url,{cache:'no-store',mode:'cors',signal:ctrl.signal});
        clearTimeout(t);
        if(!res.ok) throw new Error('Bad status '+res.status);
        const dateHdr=res.headers.get('Date') || new Date().toUTCString();
        document.getElementById('updatedTop').textContent='Updated: '+dateHdr;
        return await res.text();
      }catch(err){
        console.warn('[CSV] Falling back to embedded sample data because fetch failed:',err);
        document.getElementById('updatedTop').textContent='Updated: Local sample data';
        return FALLBACK_CSV;
      }
    }

    (async function init(){
      const sources=[
        'https://cdn.jsdelivr.net/npm/world-countries@4/countries.geo.json',
        'https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson',
        'https://unpkg.com/@geo-maps/countries-land-1m@1.0.2/countries-land-1m.geo.json'
      ];
      for(const src of sources){
        try{ const r=await fetch(src,{mode:'cors'}); if(!r.ok) throw 0; const j=await r.json(); if(j && j.features && j.features.length>100){ worldGeo=j; break; } }catch(e){}
      }
      if(!worldGeo){ console.error('World polygons failed to load'); return; }

      centroidByKey={};
      L.geoJSON(worldGeo).eachLayer(l=>{
        const p=l.feature&&l.feature.properties||{};
        const nmRaw=p.name||p.NAME||p.NAME_EN||p.ADMIN||p.SOVEREIGNT;
        if(!nmRaw) return;
        const nm=normalizeCountry(nmRaw);
        centroidByKey[nm]=CENTROID_OVERRIDES.has(nm)?L.latLng(...CENTROID_OVERRIDES.get(nm)):centroidInside(l.feature);
        if(l.feature.properties) l.feature.properties._key=nm;
      });

      outlineLayer=L.geoJSON(worldGeo,{pane:'hitPane',style:{color:getCSS('--mint'),weight:0.6,opacity:0.35,fill:false}}).addTo(map);

      shadeLayer=L.geoJSON(worldGeo,{pane:'hitPane',style:f=>({color:'#0000',weight:0,fillColor:getCSS('--red'),fillOpacity:0})}).addTo(map);

      hitLayer=L.geoJSON(worldGeo,{
        pane:'hitPane',
        style:{className:'country-hit',stroke:false,fill:true,fillColor:'#000',fillOpacity:0.01},
        interactive:true,
        onEachFeature:(f,layer)=>{
          const key=(f.properties&&f.properties._key)||'';
          const open=()=>openCountryPopup(key);
          layer.on('click',open);
          layer.on('touchstart',e=>{e.originalEvent.preventDefault(); open();});
          layer.on('mouseover',()=>layer.setStyle({stroke:true,color:getCSS('--mint'),weight:1,opacity:.6}));
          layer.on('mouseout', ()=>layer.setStyle({stroke:false}));
        }
      }).addTo(map);

      const text=await fetchCsvOrFallback(`${CSV_URL}${CSV_URL.includes('?')?'&':'?'}cb=${Date.now()}`);
      const parsed=Papa.parse(text,{header:true,skipEmptyLines:true});
      const rows=parsed.data;

      entries=[];
      for(const row of rows){
        const title=String(row["Title"]||"").trim();
        const status=String(row["Status"]||"").trim();
        const notes=String(row["Description"]||"").trim();
        const year=/^\d{4}$/.test(String(row["Year"]||"").trim())?parseInt(row["Year"]):null;
        const countriesCell=String(row["Countries"]||"").trim();
        if(!countriesCell) continue;
        for(const raw of splitCountries(countriesCell)){
          const key=normalizeCountry(raw);
          const alt=key.replace(/^(republic|kingdom)\sof\s/,'').trim();
          const pt=centroidByKey[key]||centroidByKey[alt];
          if(!pt) continue;
          const isImplemented=/implement/i.test(status);
          const isDev=/develop|discussion|pilot|trial|poc|concept/i.test(status);
          entries.push({key,country:titleCase(key),lat:pt.lat,lng:pt.lng,status,isImplemented,isDev,title,notes,year});
        }
      }

      drawAll();

      console.assert(entries.length > 0, '[TEST] entries should not be empty');
      console.assert(dotsLayer.getLayers().length > 0, '[TEST] dots should be rendered');
    })();

    function drawAll(){
      dotsLayer.clearLayers();
      linesImpLayer.clearLayers();
      linesDevLayer.clearLayers();

      const red=getCSS('--red'), orange=getCSS('--orange');

      const bestByKey=new Map();
      for(const e of entries){
        const prev=bestByKey.get(e.key);
        if(!prev || (e.isImplemented && !prev.isImplemented)) bestByKey.set(e.key,e);
      }

      const impPts=[], devPts=[];
      const implementedShown=new Set();

      for(const [key,e] of bestByKey){
        const color=e.isImplemented?red:orange;
        L.circleMarker([e.lat,e.lng],{
          renderer:dotsRenderer, pane:'dotsPane',
          radius:6.5, color:darken(color,30), weight:1.2, fillColor:color, fillOpacity:.95
        })
        .bindTooltip(`${e.country}`,{direction:'top',offset:[0,-6]})
        .on('click',()=>openCountryPopup(key))
        .addTo(dotsLayer);

        if(e.isImplemented){ impPts.push([e.lat,e.lng]); implementedShown.add(key); }
        else               { devPts.push([e.lat,e.lng]); }
      }

      if (shadeLayer){
        const fill=getCSS('--red');
        shadeLayer.setStyle(f=>{
          const k=(f.properties&&f.properties._key)||'';
          return implementedShown.has(k)?{fillColor:fill,fillOpacity:0.14,color:'#0000',weight:0}:{fillOpacity:0,color:'#0000',weight:0};
        });
      }

      const K=3;
      buildLocalNetwork(impPts,getCSS('--red'),linesImpLayer,K,.35,1.2);
      buildLocalNetwork(devPts,getCSS('--orange'),linesDevLayer,K,.30,1.1);
    }

    function buildLocalNetwork(coords,color,layer,k=3,opacity=.35,weight=1.2){
      const n=coords.length; if(n<2) return;
      const seen=new Set();
      for(let i=0;i<n;i++){
        const dists=[];
        for(let j=0;j<n;j++){
          if(i===j) continue;
          dists.push({j,d:haversine(coords[i],coords[j])});
        }
        dists.sort((a,b)=>a.d-b.d);
        const limit=Math.min(k,dists.length);
        for(let t=0;t<limit;t++){
          const j=dists[t].j, key=i<j?`${i}-${j}`:`${j}-${i}`; if(seen.has(key)) continue; seen.add(key);
          L.polyline([coords[i],coords[j]],{pane:'linesPane',renderer:linesRenderer,interactive:false,color,weight,opacity,smoothFactor:1.0}).addTo(layer);
        }
      }
    }

    const linesPane = map.getPane('linesPane');
    map.on('zoomstart', () => { if (linesPane) linesPane.style.opacity = '0.05'; });
    map.on('zoomend',   () => { if (linesPane) linesPane.style.opacity = '1';   });
  </script>

  <style>
  /* Keeping CSS inline-minimized note at top to keep this block short */
  </style>
</body>
</html>
